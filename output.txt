
===== ./app.py =====
# ===== ./app.py (PHI√äN B·∫¢N CU·ªêI C√ôNG - S·ª¨A L·ªñI √ÇM THANH) =====
from flask import Flask, render_template, request, jsonify, session, send_from_directory
import os
import uuid
from pydub import AudioSegment
from datetime import timedelta
import json
import threading
import shutil
from typing import Dict
from concurrent.futures import ThreadPoolExecutor, as_completed
from asgiref.wsgi import WsgiToAsgi
import requests

# ... (To√†n b·ªô ph·∫ßn m√£ ngu·ªìn t·ª´ ƒë·∫ßu ƒë·∫øn h√†m process_single_line_via_api gi·ªØ nguy√™n) ...
CODESPACE_NAME = os.environ.get("CODESPACE_NAME")
if CODESPACE_NAME:
    BASE_URL = f"https://{CODESPACE_NAME}-7861.app.github.dev"
    print(f"Ph√°t hi·ªán m√¥i tr∆∞·ªùng Github Codespaces. URL c√¥ng khai ƒë∆∞·ª£c ƒë·∫∑t l√†: {BASE_URL}")
else:
    BASE_URL = os.environ.get("PUBLIC_URL")
    if not BASE_URL:
        print("C·∫¢NH B√ÅO: Kh√¥ng ph√°t hi·ªán Github Codespaces ho·∫∑c bi·∫øn m√¥i tr∆∞·ªùng PUBLIC_URL.")
        BASE_URL = None
try:
    from tts_api_client import api_client, CoquiAPIError
except ImportError as e:
    print(f"C·∫¢NH B√ÅO: Kh√¥ng th·ªÉ import tts_api_client. L·ªói g·ªëc: {e}.")
    class CoquiAPIError(Exception): pass
    class MockApiClient:
        def generate(self, *args, **kwargs): raise CoquiAPIError("Client API th·∫≠t ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai.")
    api_client = MockApiClient()
app = Flask(__name__)
app.config['SECRET_KEY'] = os.urandom(24)
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(hours=1)
app.config['UPLOAD_FOLDER'] = '/tmp/uploads'
app.config['OUTPUT_FOLDER'] = '/tmp/outputs'
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
os.makedirs(app.config['OUTPUT_FOLDER'], exist_ok=True)
LANGUAGES_FOR_API = { "English": "English", "French": "French", "Spanish": "Spanish", "German": "German", "Italian": "Italian", "Portuguese": "Portuguese", "Polish": "Polish", "Turkish": "Turkish", "Russian": "Russian", "Dutch": "Dutch", "Czech": "Czech", "Arabic": "Arabic", "Chinese": "Chinese", "Japanese": "Japanese", "Korean": "Korean", "Hungarian": "Hungarian", "Hindi": "Hindi" }
DEFAULT_VOICES = { "male_en": {"name": "English Male", "path": "samples/male_zh.mp3"}, "female_cn": {"name": "Chinese Female", "path": "samples/female_zh.mp3"} }
DEFAULT_ADVANCED_PARAMS = { 'temperature': 0.75, 'speed': 1.0, 'top_k': 50, 'top_p': 0.85, 'repetition_penalty': 5.0, 'length_penalty': 1.0 }
UI_STRINGS = {
    "en": { "script_example": "A: Hello world.\nB: Voice cloning is amazing!", "title": "XTTS Conversation Generator", "subtitle": "Create multi-speaker conversations with custom voices", "manage_speakers": "Manage Speakers", "add_speaker": "Add Speaker", "script_label": "Conversation Script", "script_placeholder": "Example:\nA: Hello world.\nB: Voice cloning is amazing!", "advanced_settings": "Advanced Settings", "generate_button": "Generate Voice", "clear_button_title": "Delete all session data and files", "results_header": "Conversation Results", "loading_generating": "Generating voice...", "loading_sending": "Sending request...", "loading_starting": "Starting...", "loading_processing": "Processing...", "error_checking_status": "Error checking status", "error_starting_job": "Invalid response from server when starting job", "error_occurred": "An error occurred", "confirm_clear": "Are you sure you want to delete all session data?", "error_clearing": "Error during cleanup", "full_conversation": "Full Conversation", "individual_lines": "Individual Lines", "no_results": "No results generated.", "speaker_id_prefix": "Speaker", "voice_select_placeholder": "-- Select Voice --", "voice_source_default": "Default", "voice_source_custom": "Custom", "current_file": "Current file", "no_file_uploaded": "No file uploaded yet."},
    "vi": { "script_example": "A: Ch√†o th·∫ø gi·ªõi.\nB: C√¥ng ngh·ªá nh√¢n b·∫£n gi·ªçng n√≥i th·∫≠t tuy·ªát v·ªùi!", "title": "Tr√¨nh t·∫°o H·ªôi tho·∫°i XTTS", "subtitle": "T·∫°o h·ªôi tho·∫°i nhi·ªÅu ng∆∞·ªùi n√≥i v·ªõi gi·ªçng t√πy ch·ªânh", "manage_speakers": "Qu·∫£n l√Ω Ng∆∞·ªùi n√≥i", "add_speaker": "Th√™m Ng∆∞·ªùi n√≥i", "script_label": "K·ªãch b·∫£n H·ªôi tho·∫°i", "script_placeholder": "V√≠ d·ª•:\nA: Ch√†o th·∫ø gi·ªõi.\nB: C√¥ng ngh·ªá nh√¢n b·∫£n gi·ªçng n√≥i th·∫≠t tuy·ªát v·ªùi!", "advanced_settings": "C√†i ƒë·∫∑t N√¢ng cao", "generate_button": "T·∫°o Gi·ªçng n√≥i", "clear_button_title": "X√≥a to√†n b·ªô session v√† file", "results_header": "K·∫øt qu·∫£ H·ªôi tho·∫°i", "loading_generating": "ƒêang t·∫°o gi·ªçng n√≥i...", "loading_sending": "ƒêang g·ª≠i y√™u c·∫ßu...", "loading_starting": "ƒêang b·∫Øt ƒë·∫ßu...", "loading_processing": "ƒêang x·ª≠ l√Ω...", "error_checking_status": "L·ªói khi ki·ªÉm tra tr·∫°ng th√°i", "error_starting_job": "Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ m√°y ch·ªß khi b·∫Øt ƒë·∫ßu c√¥ng vi·ªác", "error_occurred": "ƒê√£ x·∫£y ra l·ªói", "confirm_clear": "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu phi√™n l√†m vi·ªác?", "error_clearing": "C√≥ l·ªói x·∫£y ra khi d·ªçn d·∫πp", "full_conversation": "To√†n b·ªô H·ªôi tho·∫°i", "individual_lines": "T·ª´ng c√¢u tho·∫°i", "no_results": "Kh√¥ng c√≥ k·∫øt qu·∫£ n√†o ƒë∆∞·ª£c t·∫°o ra.", "speaker_id_prefix": "Ng∆∞·ªùi n√≥i", "voice_select_placeholder": "-- Ch·ªçn gi·ªçng --", "voice_source_default": "M·∫∑c ƒë·ªãnh", "voice_source_custom": "T√πy ch·ªânh", "current_file": "File hi·ªán t·∫°i", "no_file_uploaded": "Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n."},
    "zh": { "script_example": "A: ‰Ω†Â•Ω‰∏ñÁïå„ÄÇ\nB: ËØ≠Èü≥ÂÖãÈöÜÊäÄÊúØÁúüÊòØÂ§™Ê£í‰∫ÜÔºÅ", "title": "XTTS ÂØπËØùÁîüÊàêÂô®", "subtitle": "‰ΩøÁî®Ëá™ÂÆö‰πâÂ£∞Èü≥ÂàõÂª∫Â§öËØ¥ËØù‰∫∫ÂØπËØù", "manage_speakers": "ËØ¥ËØù‰∫∫ÁÆ°ÁêÜ", "add_speaker": "Ê∑ªÂä†ËØ¥ËØù‰∫∫", "script_label": "ÂØπËØùËÑöÊú¨", "script_placeholder": "Á§∫‰æã:\nA: ‰Ω†Â•Ω‰∏ñÁïå„ÄÇ\nB: ËØ≠Èü≥ÂÖãÈöÜÊäÄÊúØÁúüÊòØÂ§™Ê£í‰∫ÜÔºÅ", "advanced_settings": "È´òÁ∫ßÂèÇÊï∞ËÆæÁΩÆ", "generate_button": "ÁîüÊàêËØ≠Èü≥", "clear_button_title": "Âà†Èô§ÊâÄÊúâ‰ºöËØùÊï∞ÊçÆÂíåÊñá‰ª∂", "results_header": "ÂØπËØùÁªìÊûú", "loading_generating": "Ê≠£Âú®ÁîüÊàêËØ≠Èü≥...", "loading_sending": "ÂèëÈÄÅËØ∑Ê±Ç‰∏≠...", "loading_starting": "ÂºÄÂßã‰∏≠...", "loading_processing": "Â§ÑÁêÜ‰∏≠...", "error_checking_status": "Ê£ÄÊü•Áä∂ÊÄÅÊó∂Âá∫Èîô", "error_starting_job": "‰ªéÊúçÂä°Âô®Êî∂Âà∞ÁöÑÂêØÂä®‰Ωú‰∏öÂìçÂ∫îÊó†Êïà", "error_occurred": "ÂèëÁîüÈîôËØØ", "confirm_clear": "ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâ‰ºöËØùÊï∞ÊçÆÂêóÔºü", "error_clearing": "Ê∏ÖÁêÜ‰ºöËØùÊó∂Âá∫Èîô", "full_conversation": "ÂÆåÊï¥ÂØπËØù", "individual_lines": "ÂçïÂè•", "no_results": "Ê≤°ÊúâÁîüÊàêÁªìÊûú„ÄÇ", "speaker_id_prefix": "ËØ¥ËØù‰∫∫", "voice_select_placeholder": "-- ÈÄâÊã©Â£∞Èü≥ --", "voice_source_default": "ÈªòËÆ§", "voice_source_custom": "Ëá™ÂÆö‰πâ", "current_file": "ÂΩìÂâçÊñá‰ª∂", "no_file_uploaded": "Â∞öÊú™‰∏ä‰º†Êñá‰ª∂„ÄÇ"}
}
SUPPORTED_UI_LANGS = {"en": "English", "vi": "Ti·∫øng Vi·ªát", "zh": "ÁÆÄ‰Ωì‰∏≠Êñá"}
print("‚úÖ ·ª®ng d·ª•ng s·∫µn s√†ng. Ch·∫ø ƒë·ªô giao di·ªán ƒëa ng√¥n ng·ªØ.")
jobs: Dict[str, Dict] = {}
def upload_to_public_service(filepath: str) -> str:
    try:
        print(f"ƒêang upload file {filepath} l√™n tmpfiles.org...")
        with open(filepath, 'rb') as f:
            response = requests.post('https://tmpfiles.org/api/v1/upload', files={'file': f})
        response.raise_for_status()
        data = response.json()
        if data['status'] == 'success':
            public_url = data['data']['url'].replace('tmpfiles.org/', 'tmpfiles.org/dl/')
            print(f"Upload th√†nh c√¥ng! URL c√¥ng khai: {public_url}")
            return public_url
        else:
            raise CoquiAPIError(f"L·ªói khi upload l√™n tmpfiles.org: {data.get('error', {}).get('message', 'Unknown error')}")
    except requests.exceptions.RequestException as e:
        raise CoquiAPIError(f"L·ªói m·∫°ng khi upload file: {e}")

def process_single_line_via_api(args):
    line, index, total_lines, job_data, app_config, _ = args
    job_id = job_data['job_id']
    jobs[job_id]['progress'] = f"ƒêang g·ª≠i d√≤ng {index+1}/{total_lines} t·ªõi API..."
    parts = line.split(":", 1)
    if len(parts) != 2: return None
    speaker_id, text = parts[0].strip().upper(), parts[1].strip()
    language_to_generate = job_data.get('language_to_generate')
    advanced_params = job_data.get('advanced_params', {})
    config = job_data['speakers_config'][speaker_id]
    speaker_path = None
    if config.get('voice_source') == 'uploaded':
        speaker_path = job_data['voice_map'].get(f"uploaded_{speaker_id}")
    else:
        speaker_path = job_data['voice_map'].get(config.get('voice_id'))
    if not speaker_path or not os.path.exists(speaker_path):
        raise ValueError(f"Ch∆∞a ch·ªçn gi·ªçng n√≥i h·ª£p l·ªá cho '{speaker_id}'.")
    
    temp_wav_path = None
    try:
        temp_wav_path = os.path.join(app_config['UPLOAD_FOLDER'], f"clean_{uuid.uuid4()}.wav")
        AudioSegment.from_file(speaker_path).export(temp_wav_path, format="wav")
        public_reference_url = upload_to_public_service(temp_wav_path)
        
        # H√†m generate gi·ªù tr·∫£ v·ªÅ m·ªôt file WAV ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a trong /tmp
        standardized_result_path = api_client.generate(
            text=text, 
            lang=language_to_generate, 
            reference_wav_url=public_reference_url, 
            advanced_params=advanced_params
        )
        
        # ‚≠ê S·ª¨A L·ªñI: Di chuy·ªÉn file ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a v√†o th∆∞ m·ª•c output
        output_filename = os.path.basename(standardized_result_path)
        output_path_on_disk = os.path.join(app_config['OUTPUT_FOLDER'], output_filename)
        shutil.move(standardized_result_path, output_path_on_disk) # Di chuy·ªÉn thay v√¨ sao ch√©p
        
        output_url = f"/outputs/{output_filename}"
        return {"index": index, "data": {"speaker": speaker_id, "text": text, "path": output_url}, "disk_path": output_path_on_disk}
    finally:
        if temp_wav_path and os.path.exists(temp_wav_path):
            os.remove(temp_wav_path)

# ... (T·∫•t c·∫£ c√°c h√†m c√≤n l·∫°i t·ª´ run_tts_job ƒë·∫øn cu·ªëi file gi·ªØ nguy√™n, ch√∫ng ƒë√£ ƒë√∫ng)
def run_tts_job(job_id: str, job_data: dict, base_url: str):
    try:
        job_data['job_id'] = job_id
        lines = [l.strip() for l in job_data['script'].strip().split("\n") if l.strip()]
        temp_results = []
        jobs[job_id]['status'] = 'processing'
        app_config = {'OUTPUT_FOLDER': app.config['OUTPUT_FOLDER'], 'UPLOAD_FOLDER': app.config['UPLOAD_FOLDER']}
        with ThreadPoolExecutor(max_workers=8) as executor:
            tasks = [(l, i, len(lines), job_data, app_config, base_url) for i, l in enumerate(lines)]
            futures = [executor.submit(process_single_line_via_api, task) for task in tasks]
            for future in as_completed(futures):
                result = future.result()
                if result: 
                    temp_results.append(result)
        temp_results.sort(key=lambda x: x['index'])
        audio_files_data = [r['data'] for r in temp_results]
        paths_to_combine = [r['disk_path'] for r in temp_results]
        job_data['generated_output_files'] = paths_to_combine
        jobs[job_id]['progress'] = f"ƒêang g·ªôp {len(paths_to_combine)} file audio..."
        combined_path, combined_url = combine_audio_files(paths_to_combine)
        if combined_path: job_data.setdefault('generated_output_files', []).append(combined_path)
        jobs[job_id]['status'] = 'completed'
        jobs[job_id]['result'] = {"results": audio_files_data, "conversation_audio": combined_url}
    except Exception as e:
        print(f"[Job {job_id}] L·ªói khi t·∫°o TTS qua API: {e}")
        jobs[job_id]['status'] = 'failed'
        jobs[job_id]['error'] = f"Kh√¥ng th·ªÉ x·ª≠ l√Ω c√¥ng vi·ªác. Chi ti·∫øt: {str(e)}"
@app.route("/")
def index_route():
    new_ui_lang = request.args.get('lang')
    current_ui_lang = session.get('ui_lang', 'en')
    if new_ui_lang and new_ui_lang != current_ui_lang:
        session['ui_lang'] = new_ui_lang
        session.pop('script', None)
    final_ui_lang = session.get('ui_lang', 'en')
    if final_ui_lang not in UI_STRINGS: final_ui_lang = 'en'
    strings = UI_STRINGS[final_ui_lang]
    session_params = session.get('advanced_params', {})
    current_params = {**DEFAULT_ADVANCED_PARAMS, **session_params}
    session_state = { 'speakers': session.get('speakers', {'A': {'voice_source': 'default', 'voice_id': 'male_en'}, 'B': {'voice_source': 'default', 'voice_id': 'female_cn'}}), 'uploaded_voices': session.get('uploaded_voices', {}), 'script': session.get('script', strings['script_example']), 'language_to_generate': session.get('language_to_generate', 'English'), 'advanced_params': current_params }
    session.permanent = True
    return render_template("index.html", ui_lang=final_ui_lang, ui_strings=strings, supported_ui_langs=SUPPORTED_UI_LANGS, languages_for_api=LANGUAGES_FOR_API, default_voices=DEFAULT_VOICES, session_state=session_state)
@app.route("/generate", methods=["POST"])
def generate():
    data = request.form
    if not data.get('script', '').strip(): return jsonify({"error": "K·ªãch b·∫£n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng."}), 400
    session['script'] = data.get('script')
    session['speakers'] = json.loads(data.get('speakers_config', '{}'))
    session['language_to_generate'] = data.get('language_to_generate')
    advanced_params = {}
    for key in DEFAULT_ADVANCED_PARAMS.keys():
        try: advanced_params[key] = float(data.get(key))
        except (ValueError, TypeError): advanced_params[key] = DEFAULT_ADVANCED_PARAMS[key]
    session['advanced_params'] = advanced_params
    session.setdefault('uploaded_voices', {})
    voice_map = {key: value['path'] for key, value in DEFAULT_VOICES.items()}
    for sid, vdata in session.get('uploaded_voices', {}).items():
        voice_map[f"uploaded_{sid}"] = vdata['path']
    for fkey, fstorage in request.files.items():
        if fstorage.filename != '':
            sid = fkey.split('_')[-1]
            if sid in session['uploaded_voices'] and os.path.exists(session['uploaded_voices'][sid]['path']):
                os.remove(session['uploaded_voices'][sid]['path'])
            save_path, _ = handle_file_upload(fstorage)
            session['uploaded_voices'][sid] = {'path': save_path, 'name': os.path.basename(fstorage.filename)}
            voice_map[f"uploaded_{sid}"] = save_path
    session.modified = True
    clear_output_files()
    job_id = str(uuid.uuid4())
    public_url_for_job = BASE_URL if BASE_URL else request.host_url
    job_data = { 'script': session['script'], 'language_to_generate': session['language_to_generate'], 'speakers_config': session['speakers'], 'voice_map': voice_map, 'advanced_params': session['advanced_params'], 'generated_output_files': [] }
    jobs[job_id] = {'status': 'queued', 'progress': 'ƒêang ch·ªù x·ª≠ l√Ω...'}
    thread = threading.Thread(target=run_tts_job, args=(job_id, job_data, public_url_for_job))
    thread.start()
    return jsonify({"status": "processing", "job_id": job_id, "updated_session_state": session.to_dict() if hasattr(session, 'to_dict') else dict(session)})
@app.route("/status/<job_id>")
def get_status(job_id):
    job = jobs.get(job_id)
    if not job: return jsonify({"status": "failed", "error": "Job ID kh√¥ng t·ªìn t·∫°i."}), 404
    if job.get('status') in ['completed', 'failed']:
        job_info_to_return = jobs.pop(job_id)
        session.setdefault('generated_output_files', []).extend(job_info_to_return.get('generated_output_files', []))
        session.modified = True
        return jsonify(job_info_to_return)
    return jsonify(job)
def combine_audio_files(file_paths):
    if not file_paths: return None, None
    combined = AudioSegment.empty()
    for path in file_paths:
        if os.path.exists(path):
            try: combined += AudioSegment.from_file(path)
            except Exception as e: print(f"L·ªói khi ƒë·ªçc file {path} ƒë·ªÉ n·ªëi: {e}"); continue
    filename = f"conversation_{uuid.uuid4()}.wav"
    disk_path = os.path.join(app.config['OUTPUT_FOLDER'], filename)
    combined.export(disk_path, format="wav")
    return disk_path, f"/outputs/{filename}"
def clear_output_files():
    files_to_delete = session.pop('generated_output_files', [])
    for file_path in files_to_delete:
        if os.path.exists(file_path):
            try: os.remove(file_path)
            except OSError as e: print(f"L·ªói khi x√≥a file output {file_path}: {e}")
def handle_file_upload(file):
    filename = f"upload_{uuid.uuid4()}_{os.path.basename(file.filename)}"
    save_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    file.save(save_path)
    return save_path, os.path.basename(file.filename)
@app.route("/clear_all")
def clear_all_session_data():
    clear_output_files()
    for voice_data in session.get('uploaded_voices', {}).values():
        if os.path.exists(voice_data['path']):
            try: os.remove(voice_data['path'])
            except OSError as e: print(f"L·ªói khi x√≥a file upload {voice_data['path']}: {e}")
    session.clear()
    global jobs; jobs = {}
    return jsonify({"status": "success", "message": "To√†n b·ªô session v√† file ƒë√£ ƒë∆∞·ª£c x√≥a."})
asgi_app = WsgiToAsgi(app)
if __name__ == "__main__":
    import uvicorn
    print("Kh·ªüi ch·∫°y m√°y ch·ªß Uvicorn cho vi·ªác ph√°t tri·ªÉn...")
    uvicorn.run("app:asgi_app", host="0.0.0.0", port=7861, reload=True)

===== ./tts_api_client.py =====
# tts_api_client.py (PHI√äN B·∫¢N CHU·∫®N H√ìA FILE ƒê·∫¶U RA)
import time
import uuid
import os
import shutil
from typing import Optional, Dict

try:
    from gradio_client import Client
except ImportError as e:
    raise ImportError(f"Kh√¥ng th·ªÉ import gradio_client. H√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ ch·∫°y 'pip install gradio_client'. L·ªói g·ªëc: {e}")

# ‚≠ê N√ÇNG C·∫§P: Import th√™m pydub ƒë·ªÉ chu·∫©n h√≥a file
try:
    from pydub import AudioSegment
except ImportError:
    raise ImportError("Kh√¥ng th·ªÉ import pydub. H√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ ch·∫°y 'pip install pydub'.")

class CoquiAPIError(Exception): # ƒê·ªïi t√™n l·ªói ƒë·ªÉ nh·∫•t qu√°n
    """L·ªói t√πy ch·ªânh cho c√°c v·∫•n ƒë·ªÅ li√™n quan ƒë·∫øn API call."""
    pass

class CoquiAPIClient:
    def __init__(self, space_url="hasanbasbunar/Voice-Cloning-XTTS-v2"):
        print(f"ƒêang k·∫øt n·ªëi t·ªõi Gradio client: {space_url}...")
        try:
            self.client = Client(src=space_url)
            print("K·∫øt n·ªëi Gradio client th√†nh c√¥ng!")
        except Exception as e:
            print(f"L·ªñI NGHI√äM TR·ªåNG: Kh√¥ng th·ªÉ kh·ªüi t·∫°o Gradio client: {e}")
            self.client = None

    def _standardize_output_to_wav(self, temp_api_path: str) -> str:
        """
        ƒê·ªçc file k·∫øt qu·∫£ t·ª´ API (b·∫•t k·ªÉ ƒë·ªãnh d·∫°ng) v√† xu·∫•t ra m·ªôt file WAV s·∫°ch.
        ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n cho vi·ªác x·ª≠ l√Ω v·ªÅ sau.
        """
        try:
            print(f"ƒêang chu·∫©n h√≥a file k·∫øt qu·∫£ c·ªßa API: {temp_api_path}")
            # ƒê·ªçc file √¢m thanh t·ª´ ƒë∆∞·ªùng d·∫´n t·∫°m
            audio = AudioSegment.from_file(temp_api_path)
            
            # T·∫°o m·ªôt ƒë∆∞·ªùng d·∫´n m·ªõi cho file WAV ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a
            standardized_wav_path = os.path.join("/tmp", f"api_output_std_{uuid.uuid4()}.wav")
            
            # Xu·∫•t ra file WAV
            audio.export(standardized_wav_path, format="wav")
            
            print(f"ƒê√£ t·∫°o file WAV chu·∫©n h√≥a: {standardized_wav_path}")
            return standardized_wav_path
        except Exception as e:
            raise CoquiAPIError(f"L·ªói khi chu·∫©n h√≥a file √¢m thanh ƒë·∫ßu ra: {e}")

    def generate(
        self, 
        text: str, 
        lang: str, 
        reference_wav_url: str,
        advanced_params: Optional[dict] = None
    ) -> str:
        if not self.client:
            raise CoquiAPIError("Gradio client ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng.")

        api_params = {
            "text": text,
            "reference_audio_url": reference_wav_url,
            "example_audio_name": None,
            "language": lang,
            "api_name": "/voice_clone_synthesis"
        }
        
        if advanced_params:
            api_params.update(advanced_params)

        start_time = time.time()
        print(f"ƒêang g·ª≠i y√™u c·∫ßu t·ªõi API '{self.client.space_id}' v·ªõi URL tham chi·∫øu: {reference_wav_url}")

        try:
            # API tr·∫£ v·ªÅ ƒë∆∞·ªùng d·∫´n ƒë·∫øn m·ªôt file t·∫°m (c√≥ th·ªÉ l√† mp3 ho·∫∑c wav)
            temp_api_result_path = self.client.predict(**api_params)

            end_time = time.time()
            print(f"API ƒë√£ ph·∫£n h·ªìi sau {end_time - start_time:.2f} gi√¢y.")
            
            if not temp_api_result_path or not os.path.exists(temp_api_result_path):
                 raise CoquiAPIError(f"API kh√¥ng tr·∫£ v·ªÅ ƒë∆∞·ªùng d·∫´n file audio h·ª£p l·ªá. K·∫øt qu·∫£: {temp_api_result_path}")

            # ‚≠ê S·ª¨A L·ªñI: Chu·∫©n h√≥a file k·∫øt qu·∫£ n√†y th√†nh WAV tr∆∞·ªõc khi tr·∫£ v·ªÅ
            final_wav_path = self._standardize_output_to_wav(temp_api_result_path)

            return final_wav_path

        except Exception as e:
            # In l·ªói chi ti·∫øt h∆°n
            print(f"!!! L·ªñI KHI G·ªåI GRADIO API: {type(e).__name__} - {e} !!!")
            # N√©m l·∫°i l·ªói ƒë·ªÉ app.py c√≥ th·ªÉ b·∫Øt
            raise CoquiAPIError(f"L·ªói khi th·ª±c hi·ªán predict t·ª´ Gradio API: {e}")

api_client = CoquiAPIClient()
print("File tts_api_client.py (phi√™n b·∫£n chu·∫©n h√≥a ƒë·∫ßu ra) ƒë√£ ƒë∆∞·ª£c ƒë·ªçc v√† th·ª±c thi th√†nh c√¥ng.")

===== ./templates/index.html =====
<!DOCTYPE html>
<html lang="{{ ui_lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ui_strings.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #advanced-panel { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, border-width 0.3s ease-in-out; padding-top: 0; padding-bottom: 0; border-top-width: 0px; }
        #advanced-toggle:checked ~ #advanced-panel { max-height: 500px; padding-top: 1rem; padding-bottom: 1rem; border-top-width: 1px; }
        .panel { transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out; }
        .voice-source-radio { position: absolute; opacity: 0; width: 0; height: 0; }
        .voice-source-label {
            cursor: pointer; padding: 0.25rem 0.75rem; border: 1px solid #d1d5db; border-bottom-width: 0;
            background-color: #f9fafb; color: #6b7280; font-size: 0.875rem;
            border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        .voice-source-radio:checked + .voice-source-label {
            background-color: white; color: #2563eb; border-color: #d1d5db; font-weight: 600;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 16px; height: 16px; border-radius: 50%;
            background: #2563eb; cursor: pointer;
            transition: background 0.2s ease-in-out;
        }
        input[type="range"]:hover::-webkit-slider-thumb { background: #1d4ed8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl"> 
        
        <header class="text-center mb-8 relative">
            <div class="absolute top-0 right-0 text-xs sm:text-sm bg-white/50 backdrop-blur-sm px-2 py-1 rounded-md">
                {% for code, name in supported_ui_langs.items() %}
                    <a href="?lang={{ code }}" class="p-1 {{ 'font-bold text-blue-600' if code == ui_lang else 'text-gray-500 hover:text-blue-500' }}">{{ name }}</a>
                    {% if not loop.last %} <span class="text-gray-300">|</span> {% endif %}
                {% endfor %}
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600 pt-10 sm:pt-0">üéôÔ∏è {{ ui_strings.title }}</h1>
            <p class="text-gray-500 mt-2">{{ ui_strings.subtitle }}</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- C·ªôt ƒëi·ªÅu khi·ªÉn -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200/80">
                <form id="tts-form" class="space-y-6">
                    <div>
                         <label for="language_to_generate" class="block text-sm font-medium text-gray-700 mb-1">Language to Generate</label>
                         <select id="language_to_generate" name="language_to_generate" class="w-full p-2 text-sm border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                            {% for code, name in languages_for_api.items() %}
                            <option value="{{ name }}" {% if name == session_state.language_to_generate %}selected{% endif %}>{{ code }}</option>
                            {% endfor %}
                         </select>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">{{ ui_strings.manage_speakers }}</h3>
                        <div id="speakers-container" class="space-y-4"></div>
                        <button type="button" id="add-speaker-btn" class="mt-4 text-xs bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors flex items-center gap-1.5">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                            {{ ui_strings.add_speaker }}
                        </button>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <label for="script" class="block text-sm font-medium text-gray-700 mb-1">{{ ui_strings.script_label }}</label>
                        <textarea id="script" name="script" rows="6" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm transition" placeholder="{{ ui_strings.script_placeholder }}"></textarea>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-6">
                        <input type="checkbox" id="advanced-toggle" class="hidden">
                        <label for="advanced-toggle" class="cursor-pointer text-sm font-semibold text-blue-600 hover:text-blue-800 flex items-center justify-between">
                            <span>{{ ui_strings.advanced_settings }}</span>
                            <svg class="w-4 h-4 transition-transform transform" id="advanced-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </label>
                        <div id="advanced-panel" class="mt-4 border-gray-200">
                             <div id="advanced-sliders" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <!-- C√°c thanh tr∆∞·ª£t s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·ªüi JS -->
                             </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3 pt-4">
                        <button type="submit" id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 text-base">
                            {{ ui_strings.generate_button }}
                        </button>
                        <button type="button" id="clear-session-btn" title="{{ ui_strings.clear_button_title }}" class="flex-shrink-0 bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                </form>
            </div>

            <!-- C·ªôt k·∫øt qu·∫£ -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200/80 flex flex-col">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-200 pb-3">{{ ui_strings.results_header }}</h2>
                <div id="loading" class="hidden flex-col items-center justify-center flex-grow">
                    <div class="loader"></div>
                    <p id="loading-message" class="mt-4 text-gray-500"></p>
                </div>
                <div id="error-message" class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                <div id="result-area" class="space-y-4 overflow-y-auto flex-grow">
                    <div id="result-placeholder" class="flex flex-col items-center justify-center h-full text-center text-gray-400">
                        <svg class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.636 5.636a9 9 0 0112.728 0M18.364 18.364A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                        <p>{{ ui_strings.no_results }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.search.includes('lang=')) {
                history.replaceState(null, '', window.location.pathname);
            }

            // --- DATA ---
            let sessionState = {{ session_state|tojson|safe }};
            const defaultVoices = {{ default_voices|tojson|safe }};
            const UI_STRINGS = {{ ui_strings|tojson|safe }};
            const ADVANCED_PARAMS_CONFIG = {
                'temperature': { min: 0, max: 1, step: 0.05 }, 'speed': { min: 0.5, max: 2.0, step: 0.05 },
                'top_k': { min: 1, max: 100, step: 1 }, 'top_p': { min: 0.1, max: 1, step: 0.05 },
                'repetition_penalty': { min: 1, max: 10, step: 0.5 }, 'length_penalty': { min: 1, max: 10, step: 0.5 }
            };

            // --- ELEMENTS ---
            const form = document.getElementById('tts-form');
            const speakersContainer = document.getElementById('speakers-container');
            const addSpeakerBtn = document.getElementById('add-speaker-btn');
            const clearSessionBtn = document.getElementById('clear-session-btn');
            const generateBtn = document.getElementById('generate-btn');
            const loadingSpinner = document.getElementById('loading');
            const loadingMessage = document.getElementById('loading-message');
            const errorMessageDiv = document.getElementById('error-message');
            const resultArea = document.getElementById('result-area');
            const resultPlaceholder = document.getElementById('result-placeholder');
            const advancedToggle = document.getElementById('advanced-toggle');
            const advancedArrow = document.getElementById('advanced-arrow');
            const advancedSlidersContainer = document.getElementById('advanced-sliders');

            let pollInterval;
            
            // --- H√ÄM ---
            function createDefaultVoiceOptions(selectedVoiceId) {
                let options = `<option value="">${UI_STRINGS.voice_select_placeholder}</option>`;
                for (const [id, voice] of Object.entries(defaultVoices)) {
                    options += `<option value="${id}" ${id === selectedVoiceId ? 'selected' : ''}>${voice.name}</option>`;
                }
                return options;
            }

            function createSpeakerCard(speakerId, speakerConfig) {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 rounded-xl shadow-sm overflow-hidden border border-gray-200';
                card.dataset.speakerId = speakerId;
                const hasUploadedVoice = sessionState.uploaded_voices && sessionState.uploaded_voices[speakerId];
                const useUploaded = speakerConfig.voice_source === 'uploaded' && hasUploadedVoice;
                card.innerHTML = `
                    <div class="bg-gray-100 p-3 flex justify-between items-center border-b border-gray-200">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 flex items-center justify-center bg-blue-600 text-white font-semibold rounded-full text-base">${speakerId}</span>
                            <h4 class="text-base font-semibold text-gray-800">${UI_STRINGS.speaker_id_prefix} ${speakerId}</h4>
                        </div>
                        <button type="button" class="remove-speaker-btn text-gray-400 hover:text-red-600 transition-colors p-1 rounded-full">
                            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div>
                        <div class="flex border-b border-gray-200 bg-white">
                            <input type="radio" id="source_default_${speakerId}" name="source_${speakerId}" value="default" class="voice-source-radio" ${!useUploaded ? 'checked' : ''}>
                            <label for="source_default_${speakerId}" class="voice-source-label">${UI_STRINGS.voice_source_default}</label>
                            <input type="radio" id="source_uploaded_${speakerId}" name="source_${speakerId}" value="uploaded" class="voice-source-radio" ${useUploaded ? 'checked' : ''}>
                            <label for="source_uploaded_${speakerId}" class="voice-source-label">${UI_STRINGS.voice_source_custom}</label>
                        </div>
                        <div class="p-4 bg-white space-y-3">
                            <div class="panel panel-default" style="max-height: ${useUploaded ? '0' : '500px'}; opacity: ${useUploaded ? '0' : '1'};">
                               <select name="voice_${speakerId}" class="voice-select w-full p-2 text-sm border-gray-300 rounded-lg">${createDefaultVoiceOptions(speakerConfig.voice_id)}</select>
                            </div>
                            <div class="panel panel-custom" style="max-height: ${!useUploaded ? '0' : '500px'}; opacity: ${!useUploaded ? '0' : '1'};">
                                <div class="mb-2">
                                    ${hasUploadedVoice ? `<p class="text-xs text-gray-800">${UI_STRINGS.current_file}: <span class="font-semibold text-green-600">${sessionState.uploaded_voices[speakerId].name}</span></p>` : `<p class="text-xs text-gray-500">${UI_STRINGS.no_file_uploaded}</p>`}
                                </div>
                                <input type="file" name="file_${speakerId}" class="voice-file w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-lg file:border file:border-gray-200 file:font-semibold file:bg-gray-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors" accept="audio/*">
                            </div>
                        </div>
                    </div>`;
                speakersContainer.appendChild(card);
                card.querySelector('.remove-speaker-btn').addEventListener('click', () => card.remove());
                card.querySelectorAll(`input[name="source_${speakerId}"]`).forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const showCustom = e.target.value === 'uploaded';
                        card.querySelector('.panel-default').style.maxHeight = showCustom ? '0' : '500px';
                        card.querySelector('.panel-default').style.opacity = showCustom ? '0' : '1';
                        card.querySelector('.panel-custom').style.maxHeight = showCustom ? '500px' : '0';
                        card.querySelector('.panel-custom').style.opacity = showCustom ? '1' : '0';
                    });
                });
            }
            
            function getNextSpeakerId() {
                const existingIds = Array.from(speakersContainer.querySelectorAll('[data-speaker-id]')).map(card => card.dataset.speakerId);
                let charCode = 65;
                while (true) {
                    const nextId = String.fromCharCode(charCode);
                    if (!existingIds.includes(nextId)) return nextId;
                    charCode++;
                }
            }
            
            function renderAllSpeakers() {
                speakersContainer.innerHTML = '';
                const speakersToRender = (sessionState.speakers && Object.keys(sessionState.speakers).length > 0) ? sessionState.speakers : {
                    'A': {'voice_source': 'default', 'voice_id': 'male_en'},
                    'B': {'voice_source': 'default', 'voice_id': 'female_cn'}
                };
                for (const [id, config] of Object.entries(speakersToRender)) {
                    createSpeakerCard(id, config);
                }
            }
            
            function getSpeakersConfigFromDOM() {
                const config = {};
                speakersContainer.querySelectorAll('[data-speaker-id]').forEach(card => {
                    const id = card.dataset.speakerId;
                    const sourceRadio = card.querySelector(`input[name="source_${id}"]:checked`);
                    const sourceValue = sourceRadio ? sourceRadio.value : 'default';
                    config[id] = { voice_source: sourceValue };
                    if (sourceValue === 'default') {
                        config[id].voice_id = card.querySelector('.voice-select').value;
                    }
                });
                return config;
            }
            
            function displayResults(data) {
                resultPlaceholder.classList.add('hidden');
                let resultHTML = '';
                const finalResult = data.result;
                if (finalResult.conversation_audio) {
                    resultHTML += `<div class="p-4 border-b-2 border-blue-200 bg-blue-50 rounded-lg">
                                    <h3 class="font-semibold text-sm mb-2 text-blue-800">${UI_STRINGS.full_conversation}</h3>
                                    <audio controls class="w-full h-10"><source src="${finalResult.conversation_audio}?t=${new Date().getTime()}" type="audio/wav"></audio>
                                   </div>`;
                }
                if (finalResult.results && finalResult.results.length > 0) {
                    resultHTML += `<h3 class="font-semibold text-sm mt-4 mb-2">${UI_STRINGS.individual_lines}</h3>`;
                    finalResult.results.forEach(item => {
                        resultHTML += `<div class="p-3 border rounded-lg bg-gray-50">
                                        <p class="text-sm text-gray-800"><span class="font-bold">${item.speaker}:</span> <span class="italic text-gray-600">"${item.text}"</span></p>
                                        <audio controls class="w-full mt-2 h-8"><source src="${item.path}?t=${new Date().getTime()}" type="audio/wav"></audio>
                                       </div>`;
                    });
                }
                resultArea.innerHTML = resultHTML || `<p class="text-gray-500 text-sm">${UI_STRINGS.no_results}</p>`;
            }

            function pollStatus(jobId) {
                pollInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/status/${jobId}`);
                        const data = await response.json();
                        if (data.status === 'completed') {
                            clearInterval(pollInterval);
                            loadingSpinner.classList.add('hidden');
                            generateBtn.disabled = false;
                            generateBtn.innerHTML = UI_STRINGS.generate_button;
                            displayResults(data);
                        } else if (data.status === 'failed') {
                            clearInterval(pollInterval);
                            throw new Error(data.error || UI_STRINGS.error_starting_job);
                        } else {
                            loadingMessage.textContent = data.progress || UI_STRINGS.loading_processing;
                        }
                    } catch (error) {
                        clearInterval(pollInterval);
                        errorMessageDiv.textContent = `${UI_STRINGS.error_checking_status}: ${error.message}`;
                        errorMessageDiv.classList.remove('hidden');
                        loadingSpinner.classList.add('hidden');
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = UI_STRINGS.generate_button;
                    }
                }, 2000);
            }

            function initializeAdvancedControls() {
                advancedSlidersContainer.innerHTML = ''; 
                for (const [name, config] of Object.entries(ADVANCED_PARAMS_CONFIG)) {
                    const div = document.createElement('div');
                    const label = name.charAt(0).toUpperCase() + name.slice(1).replace('_', ' ');
                    const value = sessionState.advanced_params[name] || '0.00';
                    div.innerHTML = `
                        <label for="${name}" class="block text-xs font-medium text-gray-600">${label}: <span class="param-value font-bold text-blue-600">${parseFloat(value).toFixed(2)}</span></label>
                        <input type="range" id="${name}" name="${name}" min="${config.min}" max="${config.max}" step="${config.step}" value="${value}" class="param-slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    `;
                    advancedSlidersContainer.appendChild(div);
                }
                advancedSlidersContainer.querySelectorAll('.param-slider').forEach(slider => {
                    const valueSpan = slider.previousElementSibling.querySelector('.param-value');
                    slider.addEventListener('input', () => {
                        valueSpan.textContent = parseFloat(slider.value).toFixed(2);
                    });
                });
            }
            
            // --- EVENT LISTENERS ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (pollInterval) clearInterval(pollInterval);
                generateBtn.disabled = true;
                generateBtn.innerHTML = `<span class="animate-pulse">${UI_STRINGS.loading_starting}</span>`;
                loadingSpinner.classList.remove('hidden');
                loadingMessage.textContent = UI_STRINGS.loading_sending;
                errorMessageDiv.classList.add('hidden');
                resultArea.innerHTML = ''; 
                resultPlaceholder.classList.add('hidden');
                const formData = new FormData(form);
                formData.append('speakers_config', JSON.stringify(getSpeakersConfigFromDOM()));
                document.querySelectorAll('input[type="file"]').forEach(input => {
                    if (input.files.length === 0) formData.delete(input.name);
                });
                try {
                    const response = await fetch('/generate', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `HTTP Error: ${response.status}`);
                    
                    sessionState = data.updated_session_state;
                    
                    renderAllSpeakers();
                    initializeAdvancedControls();
                    if (data.status === 'processing' && data.job_id) {
                        generateBtn.innerHTML = `<span class="animate-pulse">${UI_STRINGS.loading_processing}</span>`;
                        pollStatus(data.job_id);
                    } else {
                        throw new Error(UI_STRINGS.error_starting_job);
                    }
                } catch (error) {
                    errorMessageDiv.textContent = `${UI_STRINGS.error_occurred}: ${error.message}`;
                    errorMessageDiv.classList.remove('hidden');
                    resultPlaceholder.classList.remove('hidden');
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = UI_STRINGS.generate_button;
                    loadingSpinner.classList.add('hidden');
                }
            });
            
            addSpeakerBtn.addEventListener('click', () => {
                const newId = getNextSpeakerId();
                const firstDefaultVoiceId = Object.keys(defaultVoices)[0] || '';
                createSpeakerCard(newId, { voice_source: 'default', voice_id: firstDefaultVoiceId });
            });
            
            clearSessionBtn.addEventListener('click', async () => { 
                if (!confirm(UI_STRINGS.confirm_clear)) return;
                try {
                    const response = await fetch('/clear_all');
                    const data = await response.json();
                    if (data.status === 'success') {
                        window.location.href = window.location.pathname;
                    }
                } catch (error) {
                    alert(UI_STRINGS.error_clearing);
                }
            });

            advancedToggle.addEventListener('change', () => {
                advancedArrow.classList.toggle('rotate-180', advancedToggle.checked);
            });

            // --- INITIALIZATION ---
            document.getElementById('script').value = sessionState.script; 
            document.getElementById('language_to_generate').value = sessionState.language_to_generate;
            renderAllSpeakers();
            initializeAdvancedControls();
        });
    </script>
</body>
</html>

===== ./.devcontainer/devcontainer.json =====
// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/python
{
	"name": "Python 3",
	// Or use a Dockerfile or Docker Compose file. More info: https://containers.dev/guide/dockerfile
	"image": "mcr.microsoft.com/devcontainers/python:1-3.10-bookworm",

	// Features to add to the dev container. More info: https://containers.dev/features.
	"features": {
		"ghcr.io/devcontainers/features/docker-in-docker:2": {}
	},

	// Use 'forwardPorts' to make a list of ports inside the container available locally.
	// "forwardPorts": [],

	// Use 'postCreateCommand' to run commands after the container is created.
	"postCreateCommand": "sudo apt-get update && sudo apt-get install -y ffmpeg && pip3 install --user -r ../requirements.txt",
	// Configure tool-specific properties.
	// "customizations": {},

	// Uncomment to connect as root instead. More info: https://aka.ms/dev-containers-non-root.
	"remoteUser": "vscode"
}


===== DIRECTORY TREE =====
./
    requirements.txt
    .gitattributes
    README.md
    app.py
    tts_api_client.py
    Dockerfile
    static/
        outputs/
        uploads/
            upload_383a87b5-37c4-4228-95e0-9c62b0e9f446_ttsMP3.com_VoiceText_2025-6-29_15-45-52.mp3
            upload_f307cc8b-0371-44a9-813e-01b7fcc893fa_ttsMP3.com_VoiceText_2025-6-29_15-45-43.mp3
    templates/
        index.html
    .github/
        dependabot.yml
    samples/
        male_zh.mp3
        female_zh.mp3
    .devcontainer/
        devcontainer.json
