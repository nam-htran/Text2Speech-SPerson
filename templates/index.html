<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XTTS Dynamic Conversation Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .panel { transition: all 0.3s ease-in-out; }
        .voice-source-radio { position: absolute; opacity: 0; width: 0; height: 0; }
        .voice-source-label {
            cursor: pointer; padding: 0.25rem 0.75rem; /* Gi·∫£m padding cho tab nh·ªè h∆°n */
            border: 1px solid #d1d5db; border-bottom-width: 0;
            background-color: #f9fafb; color: #6b7280; font-size: 0.875rem; /* Ch·ªØ nh·ªè h∆°n */
            border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem;
        }
        .voice-source-radio:checked + .voice-source-label {
            background-color: white; color: #1d4ed8; border-color: #d1d5db; font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <!-- Container v·ªõi max-width ƒë·ªÉ giao di·ªán g·ªçn h∆°n tr√™n m√†n h√¨nh l·ªõn -->
    <div class="container mx-auto p-4 md:p-6 max-w-7xl"> 
        <header class="text-center mb-6">
            <!-- Ti√™u ƒë·ªÅ nh·ªè h∆°n -->
            <h1 class="text-3xl font-bold text-blue-700">üéôÔ∏è XTTS Conversation Generator</h1>
            <p class="text-slate-600 mt-1 text-sm">T·∫°o h·ªôi tho·∫°i v·ªõi ng∆∞·ªùi n√≥i t√πy ch·ªânh</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- C·ªôt ƒëi·ªÅu khi·ªÉn -->
            <div class="bg-white p-5 rounded-xl shadow-lg">
                <form id="tts-form">
                    <!-- C√†i ƒë·∫∑t chung -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5 pb-5 border-b border-slate-200">
                        <div>
                            <label for="language" class="block text-xs font-medium text-slate-600 mb-1">Ng√¥n ng·ªØ</label>
                            <select id="language" name="language" class="w-full p-2 text-sm border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                {% for code, name in languages.items() %}<option value="{{ code }}" {% if code == session_state.language %}selected{% endif %}>{{ name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="speed" class="block text-xs font-medium text-slate-600 mb-1">T·ªëc ƒë·ªô: <span id="speed-value" class="font-bold text-blue-600">{{ "%.2f"|format(session_state.speed) }}</span></label>
                            <input type="range" id="speed" name="speed" min="0.5" max="2.0" value="{{ session_state.speed }}" step="0.05" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                    
                    <!-- ‚≠ê QU·∫¢N L√ù NG∆Ø·ªúI N√ìI (THI·∫æT K·∫æ COMPACT) ‚≠ê -->
                    <div class="mb-5">
                        <h3 class="text-lg font-bold mb-3 text-slate-800">Qu·∫£n l√Ω Ng∆∞·ªùi n√≥i</h3>
                        <div id="speakers-container" class="space-y-3"></div>
                        <button type="button" id="add-speaker-btn" class="mt-3 text-xs bg-green-500 text-white font-bold py-1.5 px-3 rounded-md hover:bg-green-600 transition-colors">+ Th√™m Ng∆∞·ªùi n√≥i</button>
                    </div>

                    <!-- K·ªãch b·∫£n -->
                    <div>
                        <label for="script" class="block text-sm font-medium text-slate-700 mb-1">K·ªãch b·∫£n h·ªôi tho·∫°i</label>
                        <!-- Gi·∫£m chi·ªÅu cao m·∫∑c ƒë·ªãnh c·ªßa textarea -->
                        <textarea id="script" name="script" rows="6" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" 
                        placeholder="V√≠ d·ª•:
A: ‰Ω†Â•Ω„ÄÇ
B: ‰Ω†Â•ΩÂêóÔºü">{{ session_state.script }}</textarea>
                    </div>

                    <!-- N√∫t ƒëi·ªÅu khi·ªÉn -->
                    <div class="flex items-center space-x-3 mt-4">
                        <button type="submit" id="generate-btn" class="flex-grow bg-blue-600 text-white font-bold py-2.5 px-4 rounded-md hover:bg-blue-700 transition-colors shadow-md hover:shadow-lg text-sm">T·∫°o Gi·ªçng n√≥i</button>
                        <button type="button" id="clear-session-btn" title="X√≥a to√†n b·ªô session v√† file" class="bg-red-500 text-white p-2.5 rounded-md hover:bg-red-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    </div>
                </form>
            </div>

            <!-- C·ªôt k·∫øt qu·∫£ -->
            <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col">
                <h2 class="text-xl font-bold mb-3 border-b border-slate-200 pb-2">K·∫øt qu·∫£ H·ªôi tho·∫°i</h2>
                <div id="loading" class="hidden flex-col items-center justify-center py-10"><div class="loader"></div><p class="mt-4 text-slate-600 text-sm">ƒêang t·∫°o gi·ªçng n√≥i...</p></div>
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 text-sm"></div>
                <div id="result-area" class="space-y-3 overflow-y-auto">
                    <p id="result-placeholder" class="text-slate-500 text-center py-8 text-sm">K·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- DATA t·ª´ Server ---
        let sessionState = {{ session_state|tojson|safe }};
        const defaultVoices = {{ default_voices|tojson|safe }};

        // --- ELEMENTS ---
        const form = document.getElementById('tts-form');
        const speakersContainer = document.getElementById('speakers-container');
        const addSpeakerBtn = document.getElementById('add-speaker-btn');
        const speedInput = document.getElementById('speed');
        const speedValueSpan = document.getElementById('speed-value');
        const clearSessionBtn = document.getElementById('clear-session-btn');

        // --- FUNCTIONS ---
        function createDefaultVoiceOptions(selectedVoiceId) {
            let options = '<option value="">-- Ch·ªçn gi·ªçng --</option>';
            for (const [id, voice] of Object.entries(defaultVoices)) {
                options += `<option value="${id}" ${id === selectedVoiceId ? 'selected' : ''}>${voice.name}</option>`;
            }
            return options;
        }
        
        // ‚≠ê H√ÄM T·∫†O CARD NG∆Ø·ªúI N√ìI (THI·∫æT K·∫æ COMPACT) ‚≠ê
        function createSpeakerCard(speakerId, speakerConfig) {
            const card = document.createElement('div');
            card.className = 'bg-slate-50 rounded-lg shadow-sm overflow-hidden border border-slate-200';
            card.dataset.speakerId = speakerId;
            
            const hasUploadedVoice = sessionState.uploaded_voices && sessionState.uploaded_voices[speakerId];
            const useUploaded = speakerConfig.voice_source === 'uploaded' && hasUploadedVoice;

            card.innerHTML = `
                <!-- Card Header -->
                <div class="bg-slate-100 p-2 flex justify-between items-center border-b border-slate-200">
                    <div class="flex items-center gap-2">
                        <span class="w-7 h-7 flex items-center justify-center bg-blue-600 text-white font-semibold rounded-full text-base">${speakerId}</span>
                        <h4 class="text-base font-bold text-slate-800">Ng∆∞·ªùi n√≥i ${speakerId}</h4>
                    </div>
                    <button type="button" class="remove-speaker-btn text-slate-400 hover:text-red-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Card Body -->
                <div>
                    <div class="flex border-b border-slate-200 bg-white">
                        <input type="radio" id="source_default_${speakerId}" name="source_${speakerId}" value="default" class="voice-source-radio" ${!useUploaded ? 'checked' : ''}>
                        <label for="source_default_${speakerId}" class="voice-source-label">M·∫∑c ƒë·ªãnh</label>
                        <input type="radio" id="source_uploaded_${speakerId}" name="source_${speakerId}" value="uploaded" class="voice-source-radio" ${useUploaded ? 'checked' : ''}>
                        <label for="source_uploaded_${speakerId}" class="voice-source-label">T√πy ch·ªânh</label>
                    </div>

                    <div class="p-3 bg-white">
                        <div class="panel panel-default" style="${useUploaded ? 'display: none;' : ''}">
                           <select name="voice_${speakerId}" class="voice-select w-full p-2 text-sm border border-slate-300 rounded-md">
                                ${createDefaultVoiceOptions(speakerConfig.voice_id)}
                            </select>
                        </div>
                        <div class="panel panel-custom" style="${!useUploaded ? 'display: none;' : ''}">
                            <div class="mb-2">
                                ${hasUploadedVoice ? `<p class="text-xs text-slate-800">File hi·ªán t·∫°i: <span class="font-semibold text-green-600">${sessionState.uploaded_voices[speakerId].name}</span></p>` : '<p class="text-xs text-slate-500">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n.</p>'}
                            </div>
                            <input type="file" name="file_${speakerId}" class="voice-file w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="audio/*">
                        </div>
                    </div>
                </div>
            `;
            speakersContainer.appendChild(card);
            
            card.querySelector('.remove-speaker-btn').addEventListener('click', () => card.remove());
            card.querySelectorAll(`input[name="source_${speakerId}"]`).forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const showCustom = e.target.value === 'uploaded';
                    card.querySelector('.panel-default').style.display = showCustom ? 'none' : 'block';
                    card.querySelector('.panel-custom').style.display = showCustom ? 'block' : 'none';
                });
            });
        }
        
        function getNextSpeakerId() {
            const existingIds = Array.from(speakersContainer.querySelectorAll('[data-speaker-id]')).map(card => card.dataset.speakerId);
            let charCode = 65;
            while (true) {
                const nextId = String.fromCharCode(charCode);
                if (!existingIds.includes(nextId)) return nextId;
                charCode++;
            }
        }

        function renderAllSpeakers() {
            speakersContainer.innerHTML = '';
            const speakersToRender = (sessionState.speakers && Object.keys(sessionState.speakers).length > 0) ? sessionState.speakers : {
                'A': {'voice_source': 'default', 'voice_id': 'male_zh_mp3'},
                'B': {'voice_source': 'default', 'voice_id': 'female_zh_mp3'}
            };
            for (const [id, config] of Object.entries(speakersToRender)) {
                createSpeakerCard(id, config);
            }
        }

        function getSpeakersConfigFromDOM() {
            const config = {};
            speakersContainer.querySelectorAll('[data-speaker-id]').forEach(card => {
                const id = card.dataset.speakerId;
                const sourceRadio = card.querySelector(`input[name="source_${id}"]:checked`);
                const sourceValue = sourceRadio ? sourceRadio.value : 'default';

                if (sourceValue === 'default') {
                    config[id] = { 
                        voice_source: 'default',
                        voice_id: card.querySelector('.voice-select').value
                    };
                } else {
                    config[id] = { voice_source: 'uploaded' };
                }
            });
            return config;
        }

        // --- EVENT LISTENERS ---
        addSpeakerBtn.addEventListener('click', () => {
            const newId = getNextSpeakerId();
            const firstDefaultVoiceId = Object.keys(defaultVoices)[0] || '';
            createSpeakerCard(newId, { voice_source: 'default', voice_id: firstDefaultVoiceId });
        });

        speedInput.addEventListener('input', (e) => {
            speedValueSpan.textContent = parseFloat(e.target.value).toFixed(2);
        });
        
        clearSessionBtn.addEventListener('click', async () => { 
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu phi√™n l√†m vi·ªác?')) return;
            try {
                const response = await fetch('/clear_all');
                const data = await response.json();
                if (data.status === 'success') window.location.reload();
            } catch (error) {
                alert('C√≥ l·ªói x·∫£y ra khi d·ªçn d·∫πp session.');
            }
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const generateBtn = document.getElementById('generate-btn');
            const loadingSpinner = document.getElementById('loading');
            const errorMessageDiv = document.getElementById('error-message');
            const resultArea = document.getElementById('result-area');
            const resultPlaceholder = document.getElementById('result-placeholder');

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="animate-pulse">ƒêang x·ª≠ l√Ω...</span>';
            loadingSpinner.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            resultArea.innerHTML = ''; 
            if(resultPlaceholder) resultPlaceholder.classList.add('hidden');

            const formData = new FormData(form);
            formData.append('speakers_config', JSON.stringify(getSpeakersConfigFromDOM()));
            
            document.querySelectorAll('input[type="file"]').forEach(input => {
                if (input.files.length === 0) formData.delete(input.name);
            });

            try {
                const response = await fetch('/generate', { method: 'POST', body: formData });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || `L·ªói HTTP: ${response.status}`);
                
                sessionState = data.updated_session_state;
                renderAllSpeakers();
                
                let resultHTML = '';
                if (data.conversation_audio) {
                    resultHTML += `<div class="p-3 border-b-2 border-blue-200 bg-blue-50 rounded-lg">
                                    <h3 class="font-semibold text-sm mb-2 text-blue-800">To√†n b·ªô h·ªôi tho·∫°i</h3>
                                    <audio controls class="w-full h-10"><source src="${data.conversation_audio}?t=${new Date().getTime()}" type="audio/wav"></audio>
                                   </div>`;
                }
                if (data.results && data.results.length > 0) {
                    resultHTML += '<h3 class="font-semibold text-sm mt-3 mb-2">T·ª´ng c√¢u tho·∫°i</h3>';
                    data.results.forEach(item => {
                        resultHTML += `<div class="p-2.5 border rounded-md bg-slate-50">
                                        <p class="text-sm text-slate-800"><span class="font-bold">${item.speaker}:</span> <span class="italic text-slate-600">"${item.text}"</span></p>
                                        <audio controls class="w-full mt-2 h-8"><source src="${item.path}?t=${new Date().getTime()}" type="audio/wav"></audio>
                                       </div>`;
                    });
                }
                resultArea.innerHTML = resultHTML || '<p class="text-slate-500 text-sm">Kh√¥ng c√≥ k·∫øt qu·∫£ n√†o ƒë∆∞·ª£c t·∫°o ra.</p>';
            } catch (error) {
                errorMessageDiv.textContent = `ƒê√£ x·∫£y ra l·ªói: ${error.message}`;
                errorMessageDiv.classList.remove('hidden');
                if(resultPlaceholder) resultPlaceholder.classList.remove('hidden');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'T·∫°o Gi·ªçng n√≥i';
                loadingSpinner.classList.add('hidden');
            }
        });

        // --- INITIALIZATION ---
        renderAllSpeakers();
    </script>
</body>
</html>